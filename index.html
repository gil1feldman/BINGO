<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××œ×™××” LIVE - ×œ×•×— ×ª×•×¦××•×ª</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* ××™×¤×•×¡ ×’×œ×™×œ×” ×¨××©×™×ª - ×”××¤×œ×™×§×¦×™×” ×ª×ª×¤×•×¡ ×‘×“×™×•×§ 100% ××”×’×•×‘×” */
    body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; }
    
    /* ×¢×™×¦×•×‘ ×¤×¡ ×’×œ×™×œ×” ××•×“×¨× ×™ ×•×“×§ */
    .custom-scroll::-webkit-scrollbar { width: 5px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* ×¢×™×¦×•×‘ ×”×¦'×™×¤ (×©×•×¨×ª ×—"×›) */
    .mk-chip {
        display: flex;
        align-items: center;
        gap: 8px;
        background: white;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        height: 42px; /* ×’×•×‘×” ×§×‘×•×¢ ×œ×—×™×©×•×‘ ××“×•×™×§ */
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        transition: transform 0.1s;
    }
    
    .mk-chip:hover { transform: translateY(-1px); border-color: #94a3b8; z-index: 10; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    
    .mk-img-wrapper {
        width: 32px; height: 32px; min-width: 32px;
        border-radius: 50%; 
        background-color: #e2e8f0;
        border: 1px solid #cbd5e1;
        overflow: hidden;
        position: relative;
    }
    
    .mk-img { width: 100%; height: 100%; object-fit: cover; object-position: top; }
    
    .mk-info { overflow: hidden; display: flex; flex-direction: column; justify-content: center; line-height: 1.1; }
    .mk-name { font-size: 0.8rem; font-weight: 700; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mk-party { font-size: 0.65rem; color: #64748b; margin-top: 1px; }

    /* ×’×¨×™×“ ×¨×¡×¤×•× ×¡×™×‘×™ ×¦×¤×•×£ */
    .mk-grid {
        display: grid;
        /* ××ª××™× ××ª ××¡×¤×¨ ×”×¢××•×“×•×ª ××•×˜×•××˜×™×ª, ××™× ×™××•× 140px ×œ×›×¨×˜×™×¡ */
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 6px;
        align-content: start;
        padding-bottom: 20px; /* ×¨×•×•×— ×‘×¡×•×£ ×”×’×œ×™×œ×” */
    }
  </style>
</head>
<body class="flex flex-col h-screen w-full text-slate-800">
  
  <div class="bg-white border-b border-slate-200 px-4 py-2 z-20 shrink-0 shadow-sm flex items-center justify-between h-[60px]">
    
    <div class="flex items-center gap-4">
        <h1 class="text-xl font-black text-slate-800 tracking-tight hidden md:block">××œ×™××”<span class="text-blue-600">LIVE</span></h1>
        
        <div class="flex items-center bg-slate-100 rounded-lg p-1 border border-slate-200 focus-within:ring-2 ring-blue-500/20 transition-all">
            <input type="number" id="direct-vote-id" 
                   class="bg-transparent border-none text-sm px-2 w-28 outline-none font-mono font-bold text-slate-700 placeholder-slate-400" 
                   placeholder="××¡' ×”×¦×‘×¢×”">
            <button onclick="loadSpecificVote()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-md text-sm font-bold shadow-sm transition-colors">
                ×”×¦×’
            </button>
        </div>

        <button onclick="loadRecentVote()" class="text-xs font-medium text-slate-500 hover:text-slate-800 underline decoration-slate-300 underline-offset-4">
            ×˜×¢×Ÿ ××—×¨×•× ×”
        </button>
    </div>

    <div id="vote-header" class="hidden flex-1 text-center px-4 overflow-hidden">
        <div id="vh-title" class="text-sm font-bold text-slate-900 truncate" title=""></div>
        <div class="text-[10px] font-mono text-slate-500 flex justify-center gap-2">
            <span id="vh-date"></span> <span class="text-slate-300">|</span> <span id="vh-id"></span>
        </div>
    </div>

    <div class="w-[150px] flex justify-end">
        <button id="btn-save" onclick="downloadVisual()" class="hidden flex items-center gap-1.5 bg-slate-800 hover:bg-slate-900 text-white px-3 py-1.5 rounded-md text-xs font-bold transition-all">
            <span>ğŸ“·</span> <span>×©××•×¨ ×ª××•× ×”</span>
        </button>
    </div>
  </div>

  <div id="visual-container" class="flex-1 flex overflow-hidden p-2 gap-2 relative bg-slate-50">
      
      <div id="loader" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-50 hidden flex flex-col items-center justify-center">
          <div class="animate-spin rounded-full h-10 w-10 border-4 border-slate-200 border-t-blue-600 mb-3"></div>
          <div class="text-sm font-bold text-slate-600 animate-pulse">×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×›× ×¡×ª...</div>
      </div>

      <div id="col-for" class="flex-1 flex flex-col bg-white rounded-xl border border-green-200 shadow-sm min-w-0 h-full overflow-hidden">
          <div class="p-3 bg-green-50 border-b border-green-100 flex justify-between items-center shrink-0">
              <div class="flex items-center gap-2">
                  <span class="w-2.5 h-2.5 rounded-full bg-green-500 shadow-sm"></span>
                  <span class="font-bold text-green-900">×‘×¢×“</span>
              </div>
              <span id="count-for" class="bg-white text-green-700 px-2.5 py-0.5 rounded text-sm font-black border border-green-200 shadow-sm">0</span>
          </div>
          <div id="grid-for" class="mk-grid p-2 custom-scroll overflow-y-auto flex-1"></div>
      </div>

      <div id="col-against" class="flex-1 flex flex-col bg-white rounded-xl border border-red-200 shadow-sm min-w-0 h-full overflow-hidden">
          <div class="p-3 bg-red-50 border-b border-red-100 flex justify-between items-center shrink-0">
              <div class="flex items-center gap-2">
                  <span class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-sm"></span>
                  <span class="font-bold text-red-900">× ×’×“</span>
              </div>
              <span id="count-against" class="bg-white text-red-700 px-2.5 py-0.5 rounded text-sm font-black border border-red-200 shadow-sm">0</span>
          </div>
          <div id="grid-against" class="mk-grid p-2 custom-scroll overflow-y-auto flex-1"></div>
      </div>

      <div id="col-abstain" class="flex-1 flex flex-col bg-white rounded-xl border border-yellow-200 shadow-sm min-w-0 h-full overflow-hidden hidden">
          <div class="p-3 bg-yellow-50 border-b border-yellow-100 flex justify-between items-center shrink-0">
              <div class="flex items-center gap-2">
                  <span class="w-2.5 h-2.5 rounded-full bg-yellow-500 shadow-sm"></span>
                  <span class="font-bold text-yellow-900">× ×× ×¢</span>
              </div>
              <span id="count-abstain" class="bg-white text-yellow-700 px-2.5 py-0.5 rounded text-sm font-black border border-yellow-200 shadow-sm">0</span>
          </div>
          <div id="grid-abstain" class="mk-grid p-2 custom-scroll overflow-y-auto flex-1"></div>
      </div>

      <div id="col-novote" class="flex-1 flex flex-col bg-white rounded-xl border border-slate-200 shadow-sm min-w-0 h-full overflow-hidden hidden opacity-75">
          <div class="p-3 bg-slate-100 border-b border-slate-200 flex justify-between items-center shrink-0">
              <div class="flex items-center gap-2">
                  <span class="w-2.5 h-2.5 rounded-full bg-slate-400 shadow-sm"></span>
                  <span class="font-bold text-slate-700">×œ× ×”×¦×‘×™×¢</span>
              </div>
              <span id="count-novote" class="bg-white text-slate-600 px-2.5 py-0.5 rounded text-sm font-black border border-slate-200 shadow-sm">0</span>
          </div>
          <div id="grid-novote" class="mk-grid p-2 custom-scroll overflow-y-auto flex-1"></div>
      </div>

  </div>

  <script>
    // --- Image Handling Strategy: PROXY ---
    // ×©×™××•×© ×‘×©×™×¨×•×ª wsrv.nl ×›×“×™ ×œ×¢×§×•×£ ×—×¡×™××•×ª CORS ×©×œ ×”×›× ×¡×ª
    const PROXY_BASE = 'https://wsrv.nl/?url=';
    const KNESSET_IMG_BASE = 'https://fs.knesset.gov.il/Image/MK/';
    const KNESSET_API_IMG = 'https://knesset.gov.il/WebSiteApi/knessetapi/MKs/GetMkImage?mkId=';
    
    // ×¦×œ×œ×™×ª ×‘×¨×™×¨×ª ××—×“×œ (base64) ×œ×˜×¢×™× ×” ××”×™×¨×”
    const NO_IMG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NjYyI+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00czLTEuNzktNC00LTQtNCAxLjc5LTQgNCAxLjc5IDQgNCA0em0wIDJjLTIuNjcgMC04IDEuMzQtOCA0djJoMTZ2LTJjMC0yLjY2LTUuMzMtNC04LTR6Ii8+PC9zdmc+';

    function getMkImage(mkId) {
        // ×× ×¡×” ×œ××©×•×š ×“×¨×š ×”×¤×¨×•×§×¡×™ ××ª ×”×ª××•× ×” ×”×¨×©××™×ª
        // ××•×¡×™×£ ×¤×¨××˜×¨×™× ×œ-cache ×•×›×™×•×•×¥
        return `${PROXY_BASE}${KNESSET_IMG_BASE}${mkId}_240.jpg&w=100&h=100&fit=cover&a=top`;
    }

    function handleImgError(img) {
        // ×× ×”×©×¨×ª ×”×¨××©×™ × ×›×©×œ, ×©× ×¦×œ×œ×™×ª
        // ××¤×©×¨ ×œ×”×•×¡×™×£ ×›××Ÿ ×œ×•×’×™×§×” ×œ× ×¡×•×ª ××§×•×¨ ×©×œ×™×©×™, ××‘×œ ×œ×¨×•×‘ ×”×¤×¨×•×§×¡×™ ×¤×•×ª×¨ ×”×›×œ
        img.onerror = null; // ××•× ×¢ ×œ×•×œ××”
        img.src = NO_IMG;
    }


    // --- App Logic ---

    async function fetchJSON(url) {
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error();
            return await res.json();
        } catch (e) { return null; }
    }

    function toggleLoader(show) {
        const el = document.getElementById('loader');
        if(show) el.classList.remove('hidden');
        else el.classList.add('hidden');
    }

    async function loadRecentVote() {
        toggleLoader(true);
        const today = new Date();
        const past = new Date(); past.setDate(today.getDate() - 3);
        const fmt = d => d.toISOString().split('T')[0];
        
        try {
            const url = 'https://knesset.gov.il/WebSiteApi/knessetapi/Votes/GetVotesHeaders';
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ FromDate: fmt(past), ToDate: fmt(today), SearchType: 1 })
            });
            const data = await res.json();
            
            if(data?.Table?.length) {
                const lastId = data.Table[0].VoteId;
                document.getElementById('direct-vote-id').value = lastId;
                loadVoteData(lastId);
            } else {
                alert('×œ× × ××¦××• ×”×¦×‘×¢×•×ª ×‘-3 ×”×™××™× ×”××—×¨×•× ×™×');
                toggleLoader(false);
            }
        } catch(e) { 
            console.error(e);
            toggleLoader(false); 
        }
    }

    async function loadSpecificVote() {
        const id = document.getElementById('direct-vote-id').value;
        if(id) loadVoteData(id);
    }

    async function loadVoteData(voteId) {
        toggleLoader(true);
        
        // 1. ×§×‘×œ×ª ×¤×¨×˜×™ ×”×”×¦×‘×¢×”
        const url = `https://knesset.gov.il/WebSiteApi/knessetapi/Votes/GetVoteDetails/${voteId}`;
        const data = await fetchJSON(url);
        
        toggleLoader(false);
        if (!data || !data.VoteDetails) { alert('×œ× × ××¦××• × ×ª×•× ×™× ×œ×”×¦×‘×¢×” ×–×•'); return; }

        // 2. ×¢×“×›×•×Ÿ ×›×•×ª×¨×•×ª
        const header = data.VoteHeader ? data.VoteHeader[0] : {};
        document.getElementById('vh-title').innerText = header.ItemTitle || '×œ×œ× ×›×•×ª×¨×ª';
        document.getElementById('vh-title').title = header.ItemTitle || '';
        document.getElementById('vh-date').innerText = header.VoteDateStr || '';
        document.getElementById('vh-id').innerText = voteId;
        
        document.getElementById('vote-header').classList.remove('hidden');
        document.getElementById('btn-save').classList.remove('hidden');
        document.getElementById('btn-save').classList.add('flex');

        // 3. ×¢×™×‘×•×“ × ×ª×•× ×™×
        renderGrid(data.VoteDetails);
    }

    function renderGrid(details) {
        // ××™×¤×•×¡
        ['for', 'against', 'abstain', 'novote'].forEach(k => document.getElementById(`grid-${k}`).innerHTML = '');

        const groups = { for: [], against: [], abstain: [], novote: [] };

        details.forEach(mk => {
            const t = (mk.Title || '').trim();
            if (t === '×‘×¢×“') groups.for.push(mk);
            else if (t === '× ×’×“') groups.against.push(mk);
            else if (t === '× ×× ×¢') groups.abstain.push(mk);
            else groups.novote.push(mk);
        });

        // ×¢×“×›×•×Ÿ ××•× ×™×
        updateCount('for', groups.for.length);
        updateCount('against', groups.against.length);
        updateCount('abstain', groups.abstain.length);
        updateCount('novote', groups.novote.length);

        // ×”×¡×ª×¨×ª ×¢××•×“×•×ª ×¨×™×§×•×ª ×‘×¦×•×¨×” ×—×›××”
        // ×ª××™×“ ××¦×™×’×™× ×‘×¢×“/× ×’×“ ×›×“×™ ×œ×©××•×¨ ×¢×œ ××‘× ×”. × ×× ×¢/×œ×-×”×¦×‘×™×¢ ××•×¡×ª×¨×™× ×× ×¨×™×§×™×.
        toggleColumn('abstain', groups.abstain.length > 0);
        toggleColumn('novote', false); // ×©× ×” ×œ-true ×× ××ª×” ×¨×•×¦×” ×œ×¨××•×ª ××ª ××™ ×©×œ× ×”×¦×‘×™×¢

        // ×¨×™× ×“×•×¨
        fillColumn('for', groups.for);
        fillColumn('against', groups.against);
        fillColumn('abstain', groups.abstain);
        fillColumn('novote', groups.novote);
    }

    function updateCount(type, count) {
        document.getElementById(`count-${type}`).innerText = count;
    }

    function toggleColumn(type, show) {
        const el = document.getElementById(`col-${type}`);
        if(show) {
            el.classList.remove('hidden');
            el.classList.add('flex');
        } else {
            el.classList.add('hidden');
            el.classList.remove('flex');
        }
    }

    function fillColumn(type, list) {
        const container = document.getElementById(`grid-${type}`);
        
        // ××™×•×Ÿ ×œ×¤×™ ×©× ××¤×œ×’×”
        list.sort((a,b) => (a.FactionName||'').localeCompare(b.FactionName||''));

        list.forEach(mk => {
            const div = document.createElement('div');
            div.className = 'mk-chip';
            
            const imgSrc = getMkImage(mk.MkId);
            
            div.innerHTML = `
                <div class="mk-img-wrapper">
                    <img src="${imgSrc}" 
                         class="mk-img" 
                         loading="lazy" 
                         alt=""
                         onerror="handleImgError(this)"
                    >
                </div>
                <div class="mk-info">
                    <div class="mk-name" title="${mk.MkName}">${mk.MkName}</div>
                    <div class="mk-party">${mk.FactionName || ''}</div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // ×™×™×¦×•× ×œ×ª××•× ×”
    async function downloadVisual() {
        const el = document.getElementById('visual-container');
        const btn = document.getElementById('btn-save');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = 'â³ ××¢×‘×“...';
        btn.disabled = true;

        // ×–×× ×™×ª ××‘×˜×œ ×’×œ×™×œ×” ×¤× ×™××™×ª ×›×“×™ ×œ×¦×œ× ××ª ×›×œ ×”×ª×•×›×Ÿ
        const scrolls = el.querySelectorAll('.custom-scroll');
        const styles = [];
        scrolls.forEach(s => {
            styles.push({el: s, overflow: s.style.overflow, height: s.style.height});
            s.style.overflow = 'visible';
            s.style.height = 'auto'; // ××•×ª×— ××ª ×”×“×™×‘ ×œ×’×•×‘×” ×”×ª×•×›×Ÿ
        });
        
        try {
            const canvas = await html2canvas(el, {
                useCORS: true, // ×§×¨×™×˜×™ ×œ×ª××•× ×•×ª ××”×¤×¨×•×§×¡×™
                backgroundColor: '#f8fafc',
                scale: 2 // ××™×›×•×ª ×’×‘×•×”×”
            });
            
            const link = document.createElement('a');
            link.download = `vote_${document.getElementById('direct-vote-id').value}.png`;
            link.href = canvas.toDataURL();
            link.click();
        } catch(e) {
            console.error(e);
            alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×ª××•× ×”');
        } finally {
            // ×©×—×–×•×¨ ××¦×‘
            scrolls.forEach((s, i) => {
                s.style.overflow = styles[i].overflow;
                s.style.height = styles[i].height;
            });
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
  </script>
</body>
</html>
