<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>注专转 爪注转 - 转爪 </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* 驻住 注爪 祝  注  专砖转 */
    body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f1f5f9; font-family: system-ui, -apple-system, sans-serif; }
    
    /* 注爪 驻住  拽  */
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* 注爪 爪'驻 (专住 " 拽) */
    .mk-chip {
        display: flex;
        align-items: center;
        gap: 6px;
        background: white;
        padding: 3px 6px;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        transition: transform 0.1s;
        height: 36px; /*  拽注 拽 */
    }
    .mk-chip:hover { transform: scale(1.02); border-color: #94a3b8; z-index: 10; }
    
    .mk-img-container {
        width: 28px; height: 28px; min-width: 28px;
        border-radius: 50%; overflow: hidden;
        background-color: #e2e8f0;
        border: 1px solid #cbd5e1;
    }
    .mk-img { width: 100%; height: 100%; object-fit: cover; object-position: top; }
    
    .mk-name { font-size: 0.75rem; font-weight: 600; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mk-party { font-size: 0.65rem; color: #64748b; line-height: 1; margin-top: 1px; }

    /* 转 转 砖 专 */
    .mk-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); /* 专住 专  */
        gap: 6px;
        align-content: start;
    }
  </style>
</head>
<body class="flex flex-col h-screen w-full">
  
  <div class="bg-white shadow-sm border-b border-gray-200 p-2 z-10 shrink-0">
    <div class="max-w-[1900px] mx-auto flex items-center justify-between gap-4">
        
        <div class="flex items-center gap-3 flex-1">
            <h1 class="text-lg font-bold text-slate-800 hidden md:block"> LIVE</h1>
            
            <div class="flex bg-gray-100 rounded-md p-1 border border-gray-200">
                <input type="number" id="direct-vote-id" class="bg-transparent border-none text-sm px-2 w-24 outline-none font-mono" placeholder="Vote ID">
                <button onclick="loadSpecificVote()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-700 transition">爪</button>
            </div>
            
            <button onclick="loadRecentVote()" class="text-xs bg-gray-50 border border-gray-300 px-2 py-1.5 rounded hover:bg-gray-100 text-gray-600">爪注 专</button>
        </div>

        <div id="vote-info" class="text-center flex-1 hidden">
            <h2 id="vh-title" class="text-sm font-bold text-gray-900 truncate max-w-lg mx-auto"></h2>
            <div class="text-[10px] text-gray-500"><span id="vh-date"></span> | <span id="vh-id"></span></div>
        </div>

        <div class="flex-1 text-left hidden" id="save-btn-container">
            <button onclick="downloadVisual()" class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded hover:bg-slate-700 shadow-sm"> 砖专 转</button>
        </div>
    </div>
  </div>

  <div id="visual-container" class="flex-1 flex overflow-hidden p-2 gap-2 relative">
      
      <div id="status-overlay" class="absolute inset-0 flex items-center justify-center bg-slate-50/80 z-50 hidden">
          <div class="text-center">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
              <span id="status-text" class="text-sm text-slate-600 font-medium">注...</span>
          </div>
      </div>

      <div id="col-for" class="flex-1 flex flex-col bg-green-50/40 rounded-lg border border-green-100 min-w-0 h-full">
          <div class="p-2 bg-green-100/90 border-b border-green-200 flex justify-between items-center shrink-0">
              <span class="font-bold text-green-900 text-sm">注</span>
              <span id="count-for" class="bg-white text-green-700 px-2 rounded-md text-xs font-bold shadow-sm border border-green-100">0</span>
          </div>
          <div id="grid-for" class="mk-grid p-2 custom-scroll overflow-y-auto"></div>
      </div>

      <div id="col-against" class="flex-1 flex flex-col bg-red-50/40 rounded-lg border border-red-100 min-w-0 h-full">
          <div class="p-2 bg-red-100/90 border-b border-red-200 flex justify-between items-center shrink-0">
              <span class="font-bold text-red-900 text-sm"></span>
              <span id="count-against" class="bg-white text-red-700 px-2 rounded-md text-xs font-bold shadow-sm border border-red-100">0</span>
          </div>
          <div id="grid-against" class="mk-grid p-2 custom-scroll overflow-y-auto"></div>
      </div>

      <div id="col-abstain" class="flex-1 flex flex-col bg-yellow-50/40 rounded-lg border border-yellow-100 min-w-0 h-full hidden">
          <div class="p-2 bg-yellow-100/90 border-b border-yellow-200 flex justify-between items-center shrink-0">
              <span class="font-bold text-yellow-900 text-sm">注</span>
              <span id="count-abstain" class="bg-white text-yellow-700 px-2 rounded-md text-xs font-bold shadow-sm border border-yellow-100">0</span>
          </div>
          <div id="grid-abstain" class="mk-grid p-2 custom-scroll overflow-y-auto"></div>
      </div>

      <div id="col-novote" class="flex-1 flex flex-col bg-gray-50/40 rounded-lg border border-gray-200 min-w-0 h-full hidden">
          <div class="p-2 bg-gray-200/90 border-b border-gray-300 flex justify-between items-center shrink-0">
              <span class="font-bold text-gray-800 text-sm"> 爪注</span>
              <span id="count-novote" class="bg-white text-gray-600 px-2 rounded-md text-xs font-bold shadow-sm border border-gray-200">0</span>
          </div>
          <div id="grid-novote" class="mk-grid p-2 custom-scroll overflow-y-auto"></div>
      </div>
  </div>

  <script>
    // --- 拽转 转转 转拽转 ---
    // 砖砖 住驻专 拽专转 驻 -Referrer
    const NO_IMG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2cbdjhiIj48cGF0aCBkPSZNMTIgMTJjMi4yMSAwIDQtMS43OSA0LTRzLTEuNzktNC00LTQtNCAxLjc5LTQgNCAxLjc5IDQgNCA0em0wIDJjLTIuNjcgMC04IDEuMzQtOCA0djJoMTZ2LTJjMC0yLjY2LTUuMzMtNC04LTR6Ii8+PC9zdmc+';

    function getImgElement(mkId, mkName) {
        // 专砖转 拽专转 住专 注驻转
        // 1. 转 拽 砖专转 砖 (专 注  专)
        // 2. 转 砖专转 拽爪 砖
        // 3. API
        const src1 = `https://knesset.gov.il/images/members/m${mkId}_s.jpg`;
        const src2 = `https://fs.knesset.gov.il/Image/MK/${mkId}_240.jpg`;
        
        // 专拽 : -img 住 转 拽专 专砖,  砖 (onerror) 祝 砖,  砖 祝 爪转
        return `
            <img src="${src1}" 
                 class="mk-img" 
                 alt="${mkName}" 
                 loading="lazy"
                 referrerpolicy="no-referrer"
                 onerror="this.onerror=null; this.src='${src2}'; this.onerror=function(){this.src='${NO_IMG}'};"
            >
        `;
    }

    // --- API ---
    async function fetchJSON(url) {
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error();
            return await res.json();
        } catch (e) { return null; }
    }

    // --- 驻拽爪 ---

    function setLoading(state) {
        const el = document.getElementById('status-overlay');
        if(state) el.classList.remove('hidden');
        else el.classList.add('hidden');
    }

    async function loadRecentVote() {
        setLoading(true);
        const today = new Date();
        const past = new Date(); past.setDate(today.getDate() - 3); // 3  专
        const fmt = d => d.toISOString().split('T')[0];
        
        const url = `https://knesset.gov.il/WebSiteApi/knessetapi/Votes/GetVotesHeaders`;
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ FromDate: fmt(past), ToDate: fmt(today), SearchType: 1 })
            });
            const data = await res.json();
            if(data?.Table?.length) {
                document.getElementById('direct-vote-id').value = data.Table[0].VoteId;
                loadVoteData(data.Table[0].VoteId);
            } else {
                alert(' 爪 爪注转 专');
                setLoading(false);
            }
        } catch(e) { setLoading(false); }
    }

    async function loadSpecificVote() {
        const id = document.getElementById('direct-vote-id').value;
        if(id) loadVoteData(id);
    }

    async function loadVoteData(voteId) {
        setLoading(true);
        const url = `https://knesset.gov.il/WebSiteApi/knessetapi/Votes/GetVoteDetails/${voteId}`;
        const data = await fetchJSON(url);
        
        setLoading(false);
        if (!data || !data.VoteDetails) { alert('砖 注转 转'); return; }

        // 注 转专转
        const header = data.VoteHeader ? data.VoteHeader[0] : {};
        document.getElementById('vh-title').innerText = header.ItemTitle || ' 转专转';
        document.getElementById('vh-date').innerText = header.VoteDateStr || '';
        document.getElementById('vh-id').innerText = voteId;
        document.getElementById('vote-info').classList.remove('hidden');
        document.getElementById('save-btn-container').classList.remove('hidden');

        renderData(data.VoteDetails);
    }

    function renderData(details) {
        // 拽
        ['for', 'against', 'abstain', 'novote'].forEach(k => document.getElementById(`grid-${k}`).innerHTML = '');

        const groups = { for: [], against: [], abstain: [], novote: [] };

        details.forEach(mk => {
            const t = (mk.Title || '').trim();
            if (t === '注') groups.for.push(mk);
            else if (t === '') groups.against.push(mk);
            else if (t === '注') groups.abstain.push(mk);
            else groups.novote.push(mk);
        });

        // 注 
        document.getElementById('count-for').innerText = groups.for.length;
        document.getElementById('count-against').innerText = groups.against.length;
        document.getElementById('count-abstain').innerText = groups.abstain.length;
        document.getElementById('count-novote').innerText = groups.novote.length;

        // 住转专转 注转 专拽转 (专砖 2)
        toggleCol('abstain', groups.abstain.length > 0);
        toggleCol('novote', false); // 住转专 转 转 " 爪注"   转砖 转 -false -true,  住 拽

        //  专
        fillCol('for', groups.for);
        fillCol('against', groups.against);
        fillCol('abstain', groups.abstain);
        // fillCol('novote', groups.novote); //    住转专
    }

    function toggleCol(id, show) {
        const el = document.getElementById(`col-${id}`);
        if(show) { el.classList.remove('hidden'); el.classList.add('flex'); }
        else { el.classList.add('hidden'); el.classList.remove('flex'); }
    }

    function fillCol(type, list) {
        const container = document.getElementById(`grid-${type}`);
        //  驻 驻  砖 住专 注
        list.sort((a,b) => (a.FactionName||'').localeCompare(b.FactionName||''));

        list.forEach(mk => {
            const div = document.createElement('div');
            div.className = 'mk-chip';
            div.innerHTML = `
                <div class="mk-img-container">
                    ${getImgElement(mk.MkId, mk.MkName)}
                </div>
                <div style="overflow:hidden">
                    <div class="mk-name" title="${mk.MkName}">${mk.MkName}</div>
                    <div class="mk-party">${mk.FactionName || ''}</div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // 爪
    async function downloadVisual() {
        const el = document.getElementById('visual-container');
        // 转 住专   爪 
        const originalOverflows = [];
        el.querySelectorAll('.custom-scroll').forEach(div => {
            originalOverflows.push({el: div, val: div.style.overflow});
            div.style.overflow = 'visible'; // 砖祝  爪
        });
        
        try {
            const canvas = await html2canvas(document.body, { 
                scrollY: -window.scrollY,
                useCORS: true,
                backgroundColor: '#f1f5f9'
            });
            const link = document.createElement('a');
            link.download = `vote.png`;
            link.href = canvas.toDataURL();
            link.click();
        } catch(e) { console.error(e); }
        
        // 专转 爪
        originalOverflows.forEach(o => o.el.style.overflow = o.val);
    }
  </script>
</body>
</html>
