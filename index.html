<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×•×™×–×•××œ×™×–×¦×™×™×ª ×”×¦×‘×¢×•×ª ×›× ×¡×ª - ××ª×•×§×Ÿ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body { background-color: #f8fafc; }
    /* ×›×¨×˜×™×¡ ×—"×› ×§×•××¤×§×˜×™ ×™×•×ª×¨ */
    .mk-card { transition: all 0.2s; }
    .mk-card:hover { transform: translateY(-2px); z-index: 10; }
    .mk-img { object-fit: cover; object-position: top; background-color: #e2e8f0; }
    
    /* ×¢×™×¦×•×‘ ×’×œ×™×œ×” ×¢×“×™×Ÿ */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="text-right font-sans text-gray-800 min-h-screen p-4">
  
  <div class="max-w-[1900px] mx-auto bg-white p-6 rounded-2xl shadow-xl space-y-6">
    
    <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row gap-4 items-end justify-between">
        <div class="w-full md:w-1/2">
            <h1 class="text-2xl font-bold text-slate-800 mb-4">××¢×¨×›×ª × ×™×ª×•×— ×”×¦×‘×¢×•×ª</h1>
            <label class="text-sm font-semibold text-gray-600 mb-1 block">×”×–×Ÿ ××–×”×” ×”×¦×‘×¢×” (Vote ID)</label>
            <div class="flex gap-2">
                <input type="number" id="direct-vote-id" class="flex-1 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" placeholder="×œ×“×•×’××”: 39682">
                <button onclick="loadSpecificVote()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-bold shadow transition-colors whitespace-nowrap">
                    ×”×¦×’ ×ª×•×¦××•×ª
                </button>
            </div>
        </div>
        
        <div class="flex gap-2 w-full md:w-auto">
            <button onclick="loadRecentVote()" class="flex-1 bg-white border border-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-50 text-sm font-medium">×”×¦×‘×¢×” ××—×¨×•× ×”</button>
        </div>
    </div>

    <div id="vote-header-info" class="hidden text-center border-b border-gray-100 pb-4">
        <h2 id="vh-title" class="text-2xl font-bold text-gray-900 leading-tight"></h2>
        <div class="flex justify-center gap-3 mt-2 text-sm text-gray-500">
            <span id="vh-date"></span> â€¢ <span id="vh-id"></span>
        </div>
    </div>

    <div id="status" class="hidden text-center py-10">
      <div class="inline-flex items-center gap-3 px-4 py-2 bg-blue-50 text-blue-700 rounded-full">
        <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path></svg>
        <span class="font-medium">×˜×•×¢×Ÿ × ×ª×•× ×™× ×•×ª××•× ×•×ª...</span>
      </div>
    </div>

    <div id="visual-container" class="hidden flex flex-col md:flex-row gap-4 min-h-[500px] items-stretch">
        
        <div id="col-for" class="flex-1 flex flex-col bg-green-50/50 rounded-xl border border-green-100 min-w-0">
            <div class="p-3 bg-green-100/80 rounded-t-xl border-b border-green-200 flex justify-between items-center sticky top-0 z-20 backdrop-blur-sm">
                <span class="font-bold text-green-800 text-lg">×‘×¢×“</span>
                <span id="count-for" class="bg-white text-green-700 px-3 py-1 rounded-full font-bold shadow-sm text-sm">0</span>
            </div>
            <div id="grid-for" class="p-3 grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2 content-start"></div>
        </div>

        <div id="col-against" class="flex-1 flex flex-col bg-red-50/50 rounded-xl border border-red-100 min-w-0">
            <div class="p-3 bg-red-100/80 rounded-t-xl border-b border-red-200 flex justify-between items-center sticky top-0 z-20 backdrop-blur-sm">
                <span class="font-bold text-red-800 text-lg">× ×’×“</span>
                <span id="count-against" class="bg-white text-red-700 px-3 py-1 rounded-full font-bold shadow-sm text-sm">0</span>
            </div>
            <div id="grid-against" class="p-3 grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2 content-start"></div>
        </div>

        <div id="col-abstain" class="flex-1 flex flex-col bg-yellow-50/50 rounded-xl border border-yellow-100 min-w-0 hidden">
            <div class="p-3 bg-yellow-100/80 rounded-t-xl border-b border-yellow-200 flex justify-between items-center sticky top-0 z-20 backdrop-blur-sm">
                <span class="font-bold text-yellow-800 text-lg">× ×× ×¢</span>
                <span id="count-abstain" class="bg-white text-yellow-700 px-3 py-1 rounded-full font-bold shadow-sm text-sm">0</span>
            </div>
            <div id="grid-abstain" class="p-3 grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2 content-start"></div>
        </div>

        <div id="col-novote" class="flex-1 flex flex-col bg-gray-50 rounded-xl border border-gray-200 min-w-0 hidden">
            <div class="p-3 bg-gray-200/80 rounded-t-xl border-b border-gray-300 flex justify-between items-center sticky top-0 z-20 backdrop-blur-sm">
                <span class="font-bold text-gray-700 text-lg">×œ× ×”×¦×‘×™×¢ / × ×•×›×—</span>
                <span id="count-novote" class="bg-white text-gray-600 px-3 py-1 rounded-full font-bold shadow-sm text-sm">0</span>
            </div>
            <div id="grid-novote" class="p-3 grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2 content-start"></div>
        </div>

    </div>

    <div id="footer-actions" class="hidden text-center mt-8 pb-8">
        <button onclick="downloadVisual()" class="inline-flex items-center gap-2 bg-slate-800 text-white px-8 py-3 rounded-full hover:bg-slate-900 shadow-lg transition transform hover:scale-105">
            <span>ğŸ“·</span>
            <span>×©××•×¨ ×ª××•× ×” ×œ×©×™×ª×•×£</span>
        </button>
    </div>

  </div>

  <script>
    // --- ×”×’×“×¨×•×ª ×©×¨×ª ×ª××•× ×•×ª ---
    // ×©×™××•×© ×‘×©×¨×ª ×”×§×‘×¦×™× ×”×™×©×™×¨ ×©×œ ×”×›× ×¡×ª ×‘×“×¨×š ×›×œ×œ ×¤×•×ª×¨ ×‘×¢×™×•×ª ×˜×¢×™× ×”
    const IMG_BASE_URL = 'https://fs.knesset.gov.il/Image/MK/'; 
    const NO_IMG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2UzZThlMCI+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00czLTEuNzktNC00LTQtNCAxLjc5LTQgNCAxLjc5IDQgNCA0em0wIDJjLTIuNjcgMC04IDEuMzQtOCA0djJoMTZ2LTJjMC0yLjY2LTUuMzMtNC04LTR6Ii8+PC9zdmc+';

    async function fetchJSON(url) {
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        } catch (e) {
            console.error(e);
            return null;
        }
    }

    // --- ×œ×•×’×™×§×” ×¨××©×™×ª ---

    async function loadSpecificVote() {
        const voteId = document.getElementById('direct-vote-id').value;
        if (!voteId) { alert('× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×”×¦×‘×¢×”'); return; }
        
        loadVoteData(voteId);
    }

    async function loadRecentVote() {
        // ×˜×•×¢×Ÿ ×”×¦×‘×¢×•×ª ××”-24 ×©×¢×•×ª ×”××—×¨×•× ×•×ª ×›×“×™ ×œ××¦×•× ××ª ×”-ID ×”××—×¨×•×Ÿ
        setLoading(true);
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 2);
        const fmt = d => d.toISOString().split('T')[0];
        
        try {
            const url = `https://knesset.gov.il/WebSiteApi/knessetapi/Votes/GetVotesHeaders`;
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ FromDate: fmt(yesterday), ToDate: fmt(today), SearchType: 1 })
            });
            const data = await res.json();
            if(data && data.Table && data.Table.length > 0) {
                // ×œ×•×§×— ××ª ×”×¨××©×•×Ÿ (×”×›×™ ×—×“×©)
                const lastId = data.Table[0].VoteId;
                document.getElementById('direct-vote-id').value = lastId;
                loadVoteData(lastId);
            } else {
                alert('×œ× × ××¦××• ×”×¦×‘×¢×•×ª ×‘×™×•××™×™× ×”××—×¨×•× ×™×');
                setLoading(false);
            }
        } catch(e) {
            alert('×©×’×™××” ×‘××™×ª×•×¨ ×”×¦×‘×¢×” ××—×¨×•× ×”');
            setLoading(false);
        }
    }

    async function loadVoteData(voteId) {
        setLoading(true);
        document.getElementById('visual-container').classList.add('hidden');
        document.getElementById('footer-actions').classList.add('hidden');

        try {
            const url = `https://knesset.gov.il/WebSiteApi/knessetapi/Votes/GetVoteDetails/${voteId}`;
            const data = await fetchJSON(url);

            if (!data || !data.VoteDetails) {
                alert('×œ× × ××¦××• × ×ª×•× ×™× ×œ×”×¦×‘×¢×” ×–×•.');
                return;
            }

            const header = data.VoteHeader ? data.VoteHeader[0] : { ItemTitle: '×œ× ×™×“×•×¢', VoteDateStr: '' };
            updateHeader(header, voteId);
            renderVisuals(data.VoteDetails);

        } catch (e) {
            alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
        } finally {
            setLoading(false);
        }
    }

    // --- ×¨×™× ×“×•×¨ ×’×¨×¤×™ ××©×•×¤×¨ ---

    function renderVisuals(details) {
        // × ×™×§×•×™ ×’×¨×™×“×™×
        ['for', 'against', 'abstain', 'novote'].forEach(k => {
            document.getElementById(`grid-${k}`).innerHTML = '';
        });

        // ××™×•×Ÿ ×”× ×ª×•× ×™× ×œ××¢×¨×›×™×
        const groups = { for: [], against: [], abstain: [], novote: [] };

        details.forEach(mk => {
            const title = (mk.Title || '').trim();
            if (title === '×‘×¢×“') groups.for.push(mk);
            else if (title === '× ×’×“') groups.against.push(mk);
            else if (title === '× ×× ×¢') groups.abstain.push(mk);
            else groups.novote.push(mk); // × ×•×›×— / ×œ× ×”×¦×‘×™×¢
        });

        // ×¢×“×›×•×Ÿ ×›×•×ª×¨×•×ª ×•××¡×¤×¨×™×
        document.getElementById('count-for').innerText = groups.for.length;
        document.getElementById('count-against').innerText = groups.against.length;
        document.getElementById('count-abstain').innerText = groups.abstain.length;
        document.getElementById('count-novote').innerText = groups.novote.length;

        // ×œ×•×’×™×§×ª ×ª×¦×•×’×” ×—×›××” (×”×¡×ª×¨×ª ×¢××•×“×•×ª ×¨×™×§×•×ª)
        toggleColumn('abstain', groups.abstain.length > 0);
        toggleColumn('novote', groups.novote.length > 0);

        // ×™×¦×™×¨×ª ×”×›×¨×˜×™×¡×™×
        fillGrid('for', groups.for);
        fillGrid('against', groups.against);
        fillGrid('abstain', groups.abstain);
        fillGrid('novote', groups.novote);

        document.getElementById('visual-container').classList.remove('hidden');
        document.getElementById('footer-actions').classList.remove('hidden');
    }

    function toggleColumn(type, show) {
        const col = document.getElementById(`col-${type}`);
        if (show) {
            col.classList.remove('hidden');
            col.classList.add('flex');
        } else {
            col.classList.add('hidden');
            col.classList.remove('flex');
        }
    }

    function fillGrid(type, mkList) {
        const container = document.getElementById(`grid-${type}`);
        
        // ××™×•×Ÿ ××œ×¤×‘×™×ª×™ ×¤× ×™××™ ××• ×œ×¤×™ ×¡×™×¢×”
        mkList.sort((a, b) => (a.FactionName || '').localeCompare(b.FactionName || ''));

        mkList.forEach(mk => {
            const card = document.createElement('div');
            card.className = "mk-card bg-white p-1.5 rounded-lg shadow-sm border border-slate-100 flex flex-col items-center text-center h-full";
            
            // ×‘× ×™×™×ª URL ×œ×ª××•× ×” - × ×™×¡×™×•×Ÿ ×œ×¤×•×¨××˜ ×™×©×™×¨
            // ×¤×•×¨××˜ × ×¤×•×¥: id_240.jpg
            const imgUrl = mk.MkId ? `${IMG_BASE_URL}${mk.MkId}_240.jpg` : NO_IMG;
            
            card.innerHTML = `
                <div class="relative w-12 h-12 mb-1.5">
                    <img src="${imgUrl}" 
                         onerror="this.onerror=null; this.src='${NO_IMG}';"
                         class="mk-img w-full h-full rounded-full border border-slate-200 shadow-sm" 
                         loading="lazy"
                         alt="">
                </div>
                <div class="w-full overflow-hidden">
                    <div class="font-bold text-slate-800 text-xs truncate leading-tight mb-0.5" title="${mk.MkName}">${mk.MkName}</div>
                    <div class="text-[10px] text-slate-500 truncate">${mk.FactionName || ''}</div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function updateHeader(header, id) {
        document.getElementById('vote-header-info').classList.remove('hidden');
        document.getElementById('vh-title').innerText = header.ItemTitle || '×œ×œ× ×›×•×ª×¨×ª';
        document.getElementById('vh-date').innerText = header.VoteDateStr || '';
        document.getElementById('vh-id').innerText = `××–×”×”: ${id}`;
    }

    function setLoading(state) {
        const el = document.getElementById('status');
        if(state) el.classList.remove('hidden');
        else el.classList.add('hidden');
    }

    // --- ×™×™×¦×•× ---
    async function downloadVisual() {
        const node = document.getElementById('visual-container');
        const btnText = document.querySelector('#footer-actions button span:nth-child(2)');
        const originalText = btnText.innerText;
        
        btnText.innerText = "××™×™×¦×¨ ×ª××•× ×”...";
        
        try {
            const canvas = await html2canvas(node, {
                scale: 2, // ××™×›×•×ª ×’×‘×•×”×”
                backgroundColor: '#ffffff',
                useCORS: true,
                ignoreElements: (element) => element.classList.contains('hidden')
            });
            
            const link = document.createElement('a');
            link.download = `vote_result_${document.getElementById('direct-vote-id').value}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        } catch(e) {
            console.error(e);
            alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×ª××•× ×”');
        } finally {
            btnText.innerText = originalText;
        }
    }
  </script>
</body>
</html>
